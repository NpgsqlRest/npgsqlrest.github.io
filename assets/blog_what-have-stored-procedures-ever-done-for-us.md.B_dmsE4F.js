import{_ as a}from"./chunks/clean.DNZ6vJbd.js";import{_ as n,C as e,c as t,o as l,a5 as p,G as r}from"./chunks/framework.CgT1UzWm.js";const h="/sp1.jpeg",k="/sp2.jpeg",o="/sp3.jpeg",d="/sp4.jpeg",c="/sp5.jpeg",D=JSON.parse('{"title":"What Have PostgreSQL Functions Ever Done for Us?","titleTemplate":"NpgsqlRest","description":"Apart from security, performance, maintainability, testability, and zero boilerplate code, what have PostgreSQL stored procedures and functions ever really done for us?","frontmatter":{"layout":"doc","outline":[2,3],"title":"What Have PostgreSQL Functions Ever Done for Us?","titleTemplate":"NpgsqlRest","description":"Apart from security, performance, maintainability, testability, and zero boilerplate code, what have PostgreSQL stored procedures and functions ever really done for us?","head":[["meta",{"name":"keywords","content":"postgresql stored procedures, postgresql functions, npgsqlrest, database api, sql injection prevention, database security, api development, stored procedure benefits, data contracts"}],["meta",{"property":"og:title","content":"What Have PostgreSQL Functions Ever Done for Us?"}],["meta",{"property":"og:description","content":"Apart from security, performance, maintainability, testability, and zero boilerplate code, what have PostgreSQL stored procedures and functions ever really done for us?"}],["meta",{"property":"og:type","content":"article"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:title","content":"What Have PostgreSQL Functions Ever Done for Us?"}]]},"headers":[],"relativePath":"blog/what-have-stored-procedures-ever-done-for-us.md","filePath":"blog/what-have-stored-procedures-ever-done-for-us.md"}'),g={name:"blog/what-have-stored-procedures-ever-done-for-us.md"};function E(u,s,y,m,b,F){const i=e("BlogNav");return l(),t("div",null,[s[0]||(s[0]=p('<h1 id="what-have-postgresql-functions-ever-done-for-us" tabindex="-1">What Have PostgreSQL Functions Ever Done for Us? <a class="header-anchor" href="#what-have-postgresql-functions-ever-done-for-us" aria-label="Permalink to &quot;What Have PostgreSQL Functions Ever Done for Us?&quot;">​</a></h1><p class="blog-meta"><span>January 2026</span> · <span class="tag">PostgreSQL</span><span class="tag">Architecture</span><span class="tag">Opinion</span></p><hr><p>So, in all seriousness - what have <strong>PostgreSQL functions and stored procedures</strong> ever done for us?</p><p><img src="'+h+`" alt="What have the stored procedures ever done for us?"></p><p>In 2026, we have ORMs, microservices, serverless functions, GraphQL, and AI writing our code. Who needs stored procedures anymore? They&#39;re relics of the past, right?</p><p>Wrong.</p><p>As a general rule, every single command or query for application use - I always wrap up in a PostgreSQL user-defined function. Sometimes it&#39;s a stored procedure when I need fine-grained transaction handling, but that&#39;s rare. It&#39;s mostly functions for the majority of cases.</p><p>To use OOP terminology - they are my <strong>data contracts</strong>. The formal agreements for data exchange between PostgreSQL and application instances:</p><ul><li><strong>Function parameters</strong> = input data contracts</li><li><strong>Function results</strong> = output data contracts</li></ul><p>Functions encapsulate commands, queries, and table access. Those are private parts. Data contracts are public. They do not change unless the application changes too.</p><p>And with tools like <strong>NpgsqlRest</strong>, these functions become REST API endpoints automatically - the foundation of a radically simpler, faster, and more secure architecture.</p><p>Let me show you with a real-world example.</p><h2 id="a-real-world-story-the-function-that-evolved" tabindex="-1">A Real-World Story: The Function That Evolved <a class="header-anchor" href="#a-real-world-story-the-function-that-evolved" aria-label="Permalink to &quot;A Real-World Story: The Function That Evolved&quot;">​</a></h2><p>Suppose we have this big table in a legacy system:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> device_measurements</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bigint</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> generated</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> always</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> identity</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> primary key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> references</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> devices(device_id),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> numeric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not null</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></details><p>Standard ORM-generated table with an auto-generated integer primary key. There are indexes on <code>device_id</code> and <code>timestamp</code>.</p><p>Now, this legacy application runs thousands of queries like this for analytical reporting:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_measurements</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">order by</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">desc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></details><p>When an application runs the same query repeatedly with different parameters, that&#39;s a code smell. It&#39;s very likely the N+1 antipattern at work - parameter values fetched from one query, then another query for each result. This makes the entire application slow and sluggish.</p><p>But resolving N+1 antipatterns requires careful analysis and a full rewrite - a luxury not every legacy system can afford. Sluggish is still usable.</p><p><strong>Step 1: Extract the data contract</strong></p><p>What&#39;s the intention? Return the latest device measurement - the one record that was last inserted.</p><ul><li><strong>Input</strong>: device_id (integer)</li><li><strong>Output</strong>: single record with timestamp, device_id, value</li></ul><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create or replace</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_latest_device_measurement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">returns</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;timestamp&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double precision</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">security</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> definer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">language</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_measurements</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _device_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">order by</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">desc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></details><p>The name clearly describes the intention. Parameters and return type define the contract.</p><p>Now replace the query in the application:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> get_latest_device_measurement($</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></details><p>This makes data access readable and maintainable. It&#39;s Clean Code for SQL - Uncle Bob would be proud.</p><p>Performance-wise, we didn&#39;t change anything. Yet. But we made the application infinitely more maintainable.</p><hr><p><strong>As time goes on, data grows.</strong> Who could have predicted that?</p><p>The decision was made to migrate to TimescaleDB and partition this table on the timestamp field.</p><p>TimescaleDB partitions don&#39;t allow unique indexes on fields not used for partitioning. The primary key on <code>id</code> had to be dropped.</p><p>Our function relied on ordering by that primary key index. Dropping it made reporting unusable.</p><p>Luckily, functions can be changed atomically - <strong>no downtime, no application change</strong>:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create or replace</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_latest_device_measurement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">returns</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;timestamp&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double precision</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">security</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> definer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">language</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_measurements</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _device_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">order by</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;timestamp&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> desc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></details><p>That worked fine. Right index used, a few partitions, reports usable again.</p><hr><p><strong>As time goes on, data grows.</strong> Again!</p><p>Although this version used indexes, it had to scan each partition separately. As partitions grew, reporting became unusable again.</p><p>New strategy - add a composite index:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> index</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_measurements (device_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> desc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></details><p>Query the max timestamp first, then locate the record:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create or replace</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_latest_device_measurement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">returns</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;timestamp&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double precision</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">security</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> definer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">language</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cte </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    select</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_measurements</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _device_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">device_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_measurements m</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cte </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">on</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">max</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">device_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _device_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></details><p>Execution plan shows only one partition scanned. Reports are fast again.</p><p><strong>Zero application changes. Zero downtime.</strong></p><hr><p><strong>As time goes on, data grows.</strong> Crazy, right?</p><p>Now we have hundreds of partitions. The query scans only the last partition, but planning time is almost a second. The engine takes too long figuring out what to do.</p><p>New approach - query only the physical partition (TimescaleDB chunk) directly:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create or replace</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_latest_device_measurement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">returns</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;timestamp&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">integer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> double precision</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">security</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> definer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">language</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plpgsql </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">declare</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _table </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _record record;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- Find the latest chunk</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk_schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk_name</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    into</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _table</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    from</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> timescaledb_information</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">chunks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hypertable_schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;public&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hypertable_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;device_measurements&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    order by</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> range_end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">desc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- Query only that chunk</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    execute</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cte </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            select</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$s</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        select</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">device_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$s m</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cte </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">on</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">max</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        where</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">device_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$, _table) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">into</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _record;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    select</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> _record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">_record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">device_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">_record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$$;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div></details><p>And it works. Latest measurements returned fast. Reports usable again.</p><hr><p><strong>The function evolved four times.</strong> The implementation went from simple query to CTE to dynamic SQL targeting specific partitions.</p><p><strong>The application never changed.</strong> Not once.</p><p><strong>Zero downtime.</strong> Every time.</p><p>That&#39;s the power of functions as data contracts. When software architects talk about encapsulation and abstraction, they&#39;re making a huge mistake when they don&#39;t talk about database functions.</p><p>And they usually don&#39;t.</p><p><img src="`+k+`" alt="Apart from security, what have stored procedures ever done for us?"></p><h2 id="security" tabindex="-1">Security? <a class="header-anchor" href="#security" aria-label="Permalink to &quot;Security?&quot;">​</a></h2><p>This is the <strong>principle of least privilege</strong> - the same approach militaries use. They call it &quot;need-to-know basis.&quot; If you&#39;re captured by the enemy, you can&#39;t tell them what you don&#39;t know.</p><p>The military takes security seriously. So should we.</p><p>The architecture is simple: <strong>two schemas</strong>.</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Private schema: tables and internal functions</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> schema</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.device_measurements (...);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Public schema: API functions only</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> schema</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> measurements</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Application role: can ONLY use the measurements schema</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> role</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> app_user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">login</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> password</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;***&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">grant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> usage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">on</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> measurements </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> app_user;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></details><p>That&#39;s it. The application connects as <code>app_user</code>, which can only call functions in the <code>measurements</code> schema. No table access. No access to the <code>data</code> schema.</p><p>API functions use <code>SECURITY DEFINER</code> to access protected data:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> measurements</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.get_latest(_device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">returns</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;timestamp&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> numeric</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">security</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> definer  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Runs as the function owner, not the caller</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> search_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_catalog, pg_temp  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Protect against search path attacks</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">language</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    select</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    from</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">device_measurements</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _device_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    order by</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;timestamp&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> desc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></details><p>Even if attackers steal your application credentials, they can only call the functions you&#39;ve exposed. They cannot <code>SELECT * FROM data.device_measurements</code> or dump your tables.</p><p><strong>What does this mean for security?</strong></p><ol><li><p><strong>SQL injection becomes structurally impossible.</strong> Your application passes parameters to functions. There&#39;s no SQL string to inject into.</p></li><li><p><strong>Data exfiltration requires compromising the database itself.</strong> Attackers can only call exposed functions - not access tables directly.</p></li><li><p><strong>Audit trails are built-in.</strong> PostgreSQL can log every function call with parameters.</p></li></ol><p>For a complete authentication example with password hashing, see <a href="/blog/database-level-security-postgresql-authentication.html">Database-Level Security</a>.</p><p><img src="`+o+`" alt="Apart from security and performance, what have stored procedures ever done for us?"></p><h2 id="performance" tabindex="-1">Performance? <a class="header-anchor" href="#performance" aria-label="Permalink to &quot;Performance?&quot;">​</a></h2><p>Everyone knows stored procedures are fast. But <em>why</em> and <em>how much</em>?</p><p><strong>No Network Round-Trips</strong></p><details class="code-collapsible" open><summary>javascript</summary><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Traditional: multiple round-trips</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;SELECT * FROM users WHERE id = $1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [userId]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> orders</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;SELECT * FROM orders WHERE user_id = $1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [userId]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> items</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orders.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">o</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;SELECT * FROM order_items WHERE order_id = $1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [o.id])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></details><p>Dozens of network round-trips. Each adds latency.</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- PostgreSQL function: 1 round-trip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> api</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.get_user_with_orders(p_user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">returns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">language</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;user&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, to_jsonb(u),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;orders&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_agg(jsonb_build_object(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;order&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, to_jsonb(o),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;items&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb_agg(to_jsonb(oi))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order_items oi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> oi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">order_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> orders o </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users u </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p_user_id;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></details><p><strong>Real Benchmark Numbers</strong></p><p>From our <a href="/blog/postgresql-rest-api-benchmark-2026.html">2026 benchmark</a>:</p><div class="table-container"><div class="table-wrapper"><table tabindex="0"><thead><tr><th>Scenario</th><th>NpgsqlRest</th><th>Traditional ORMs</th></tr></thead><tbody><tr><td>100 VU, 1 record</td><td><strong>4,588 req/s</strong></td><td>1,700-3,500 req/s</td></tr><tr><td>100 VU, 100 records</td><td><strong>377 req/s</strong></td><td>110-330 req/s</td></tr><tr><td>Pure HTTP overhead</td><td><strong>16,065 req/s</strong></td><td>5,000-9,000 req/s</td></tr></tbody></table></div></div><p>That&#39;s <strong>2-3x faster</strong> than typical ORM-based solutions.</p><p><strong>PostgreSQL Does the Heavy Lifting</strong></p><p>PostgreSQL&#39;s query optimizer has decades of development. It knows your indexes, statistics, and data distribution. Your hand-written application code doesn&#39;t.</p><p><img src="`+d+`" alt="Apart from security, performance, and maintainability, what have stored procedures ever done for us?"></p><h2 id="maintainability" tabindex="-1">Maintainability? <a class="header-anchor" href="#maintainability" aria-label="Permalink to &quot;Maintainability?&quot;">​</a></h2><p>Here&#39;s a scenario every developer knows:</p><blockquote><p>Users see incorrect data on their dashboard. Bug. Now what?</p></blockquote><p><strong>With functions:</strong></p><ol><li>Connect to PostgreSQL with any query tool</li><li>Call the function: <code>SELECT * FROM api.get_dashboard_data(123);</code></li><li>Examine the result</li></ol><p>Within seconds, you know if the bug is in database logic or frontend. If it&#39;s in the function:</p><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Fix deployed in seconds, zero downtime</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create or replace</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> api</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.get_dashboard_data(p_user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">returns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">language</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- Fixed logic</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></details><p>No recompilation. No redeployment. No container restarts. No CI/CD pipelines.</p><p><strong>Compare to traditional:</strong></p><ol><li>Find the relevant microservice</li><li>Clone repo, set up dev environment</li><li>Track bug across controllers, services, repositories, mappers</li><li>Fix, test, commit, PR, review, merge</li><li>Wait for CI/CD</li><li>Verify in production</li></ol><p>Hours or days vs. minutes.</p><h3 id="the-black-box-principle" tabindex="-1">The Black Box Principle <a class="header-anchor" href="#the-black-box-principle" aria-label="Permalink to &quot;The Black Box Principle&quot;">​</a></h3><p>Your database with functions becomes a <strong>black box</strong> - defined inputs, defined outputs, hidden complexity.</p><ul><li>Multiple applications share the same data layer without duplicating logic</li><li>Schema changes happen behind the interface without breaking clients</li><li>Optimize queries internally without changing the API contract</li></ul><p>The device_measurements story demonstrates this perfectly - four completely different implementations, same interface, application never knew.</p><h2 id="zero-boilerplate-code" tabindex="-1">Zero Boilerplate Code? <a class="header-anchor" href="#zero-boilerplate-code" aria-label="Permalink to &quot;Zero Boilerplate Code?&quot;">​</a></h2><p>This is where NpgsqlRest changes everything.</p><p>Traditional REST API:</p><ol><li>Define database schema</li><li>Create entity classes</li><li>Create repository interfaces</li><li>Implement repositories</li><li>Create service classes</li><li>Create DTOs</li><li>Create controllers</li><li>Configure routing</li><li>Add validation</li><li>Handle serialization</li></ol><p><strong>With NpgsqlRest:</strong></p><ol><li>Define functions in PostgreSQL</li><li>Done.</li></ol><details class="code-collapsible" open><summary>sql</summary><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- This IS your API endpoint: POST /api/create-user</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">create</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> api</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_user(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p_role </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;user&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">returns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jsonb</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">language</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">begin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">insert into</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users (email, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">values</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (p_email, p_name, p_role)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">returning jsonb_build_object(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, id, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;email&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, email, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></details><p>NpgsqlRest automatically:</p><ul><li>Creates endpoints from function names</li><li>Maps HTTP methods (<code>create_</code> = POST, <code>get_</code> = GET)</li><li>Validates parameter types</li><li>Serializes responses</li><li>Handles errors</li><li>Respects PostgreSQL security</li></ul><p>From our benchmark: <strong>21 lines of configuration</strong> vs. <strong>140-350 lines</strong> in other frameworks.</p><h2 id="but-what-about-version-control" tabindex="-1">&quot;But What About Version Control?&quot; <a class="header-anchor" href="#but-what-about-version-control" aria-label="Permalink to &quot;&quot;But What About Version Control?&quot;&quot;">​</a></h2><blockquote><p>&quot;While I like postgres functions, the fact that you can change them without touching application code isn&#39;t that much of a big advantage. SQL needs to be managed with the same release process as the app.&quot;</p></blockquote><p>Fair point. Here&#39;s what we do:</p><p>Use <strong>Flyway</strong>, <strong>Liquibase</strong>, or similar migration tools. Each function goes in a <strong>repeatable migration file</strong> - one file per function.</p><p>When a function changes:</p><ol><li>Edit the repeatable migration file (not the server directly)</li><li>Test locally</li><li>Commit, push, PR, review</li><li>Deploy migration - only that function gets altered</li></ol><p>You get version control, code review, and CI/CD - but deployment only updates the changed function. No container restarts, no rolling deployments, no load balancer reconfiguration.</p><p>The distinction is: <strong>managed change</strong> vs. <strong>emergency fix</strong>. The evolution story was about production optimization without planned downtime. For normal development, use proper migration workflows.</p><h2 id="but-what-about" tabindex="-1">&quot;But What About...&quot; <a class="header-anchor" href="#but-what-about" aria-label="Permalink to &quot;&quot;But What About...&quot;&quot;">​</a></h2><h3 id="orms-are-more-productive" tabindex="-1">&quot;ORMs are more productive&quot; <a class="header-anchor" href="#orms-are-more-productive" aria-label="Permalink to &quot;&quot;ORMs are more productive&quot;&quot;">​</a></h3><p>Are they? Count the lines of code. Count the bugs. Count the hours debugging ORM-generated SQL. Count the time on N+1 query problems.</p><p>The device_measurements application had N+1 problems that made it sluggish. A function can&#39;t fix that (you still need to refactor), but at least you can optimize the individual queries without touching the application.</p><h3 id="sql-is-hard-to-maintain" tabindex="-1">&quot;SQL is hard to maintain&quot; <a class="header-anchor" href="#sql-is-hard-to-maintain" aria-label="Permalink to &quot;&quot;SQL is hard to maintain&quot;&quot;">​</a></h3><p>SQL is a declarative language designed for data operations. It&#39;s been refined for 50 years.</p><p>Is it harder to maintain than:</p><ul><li>17 microservices</li><li>Each with their own ORM configuration</li><li>Duplicated business logic</li><li>Inconsistent data handling</li><li>Complex deployment pipelines</li></ul><h3 id="what-about-complex-business-logic" tabindex="-1">&quot;What about complex business logic?&quot; <a class="header-anchor" href="#what-about-complex-business-logic" aria-label="Permalink to &quot;&quot;What about complex business logic?&quot;&quot;">​</a></h3><p>PL/pgSQL supports variables, loops, conditionals, exception handling, custom types, table functions, triggers, and procedures for multi-statement transactions.</p><p>If your logic is too complex for SQL, ask: is it <strong>data logic</strong> or <strong>application logic</strong>? Data logic belongs in the database. Application logic (UI rendering, external API calls, file processing) belongs in your application.</p><h2 id="the-npgsqlrest-architecture" tabindex="-1">The NpgsqlRest Architecture <a class="header-anchor" href="#the-npgsqlrest-architecture" aria-label="Permalink to &quot;The NpgsqlRest Architecture&quot;">​</a></h2><p>NpgsqlRest embraces this philosophy completely. Your PostgreSQL functions <strong>are</strong> your API.</p><p><img src="`+a+'" alt="NpgsqlRest Clean Architecture"></p><p>At the core sits PostgreSQL with its tables, schemas, types, and domains. The next layer - user-defined functions and stored procedures - forms the API boundary. Everything inside is private; the function interface is public.</p><p>NpgsqlRest wraps this with:</p><ul><li><strong>Automatic HTTP REST API</strong> - Endpoints derived from function signatures</li><li><strong>Auto-generated TypeScript/JavaScript</strong> - Type-safe client code</li><li><strong>Auto-generated OpenAPI</strong> - Documentation and tooling</li><li><strong>Auto-generated HTTP files</strong> - For testing in VS Code/JetBrains</li><li><strong>Server-Sent Events</strong> - Real-time streaming from PostgreSQL</li><li><strong>CSV and Excel Ingestion</strong> - Upload handling built-in</li><li><strong>Caching, Rate Limiting, HA</strong> - Production-ready features</li><li><strong>Cookies, Tokens, JWT, OAuth</strong> - Authentication options</li></ul><p>All of this from your PostgreSQL schema. No controllers, no services, no repositories, no DTOs, no mappers.</p><h3 id="the-code-you-don-t-write" tabindex="-1">The Code You Don&#39;t Write <a class="header-anchor" href="#the-code-you-don-t-write" aria-label="Permalink to &quot;The Code You Don&#39;t Write&quot;">​</a></h3><p>When your API is defined as PostgreSQL functions, entire application layers disappear:</p><div class="table-container"><div class="table-wrapper"><table tabindex="0"><thead><tr><th>Traditional Layer</th><th>What It Does</th><th>With Functions</th></tr></thead><tbody><tr><td>Repository layer</td><td>Data access abstraction</td><td><strong>Eliminated</strong> - functions ARE the abstraction</td></tr><tr><td>Service layer</td><td>Business logic</td><td><strong>PostgreSQL functions</strong> - logic lives in the database</td></tr><tr><td>Controller/routes</td><td>HTTP handling</td><td><strong>Auto-generated</strong> from function signatures</td></tr><tr><td>DTOs/Models</td><td>Data transfer objects</td><td><strong>Eliminated</strong> - function parameters define the contract</td></tr><tr><td>TypeScript types</td><td>Frontend type safety</td><td><strong>Auto-generated</strong> from function metadata</td></tr><tr><td>OpenAPI docs</td><td>API documentation</td><td><strong>Auto-generated</strong> from function signatures</td></tr><tr><td>Validation logic</td><td>Input validation</td><td><strong>PostgreSQL</strong> - type system enforces constraints</td></tr></tbody></table></div></div><p>From our <a href="/blog/postgresql-rest-api-benchmark-2026.html">benchmark comparison</a>: <strong>21 lines of configuration</strong> vs. <strong>140-350 lines</strong> in traditional frameworks - for the same functionality.</p><p><strong>Real-world validation</strong>: One documented project saved <strong>~7,300 lines of code</strong> - a <strong>57% reduction</strong> in total codebase size.</p><p>That&#39;s not just less typing. That&#39;s:</p><ul><li>Fewer bugs (every line is a potential bug)</li><li>Less maintenance (code you don&#39;t write can&#39;t break)</li><li>Faster onboarding (less code to understand)</li><li>Smaller attack surface (less code to audit)</li></ul><p>Benefits:</p><ul><li><strong>Type safety</strong>: PostgreSQL validates all inputs</li><li><strong>Documentation</strong>: Function signatures self-document your API</li><li><strong>Versioning</strong>: Schema-based (<code>api_v1.get_user</code>, <code>api_v2.get_user</code>)</li><li><strong>Testing</strong>: Test functions directly in PostgreSQL</li><li><strong>Debugging</strong>: Call functions to reproduce issues</li><li><strong>Performance</strong>: One network hop, optimized queries</li></ul><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>So, apart from:</p><ul><li><strong>Data Contracts</strong> - Formal input/output agreements that survive implementation changes</li><li><strong>Security</strong> - SQL injection immunity, least privilege, built-in audit trails</li><li><strong>Performance</strong> - 2-3x faster, no N+1 queries, optimized execution plans</li><li><strong>Maintainability</strong> - Debug in seconds, fix in place, zero downtime</li><li><strong>Evolvability</strong> - Four implementations, same interface, application unchanged</li><li><strong>Code Elimination</strong> - 57-95% less code, 7,300+ lines saved in real projects</li></ul><p>...what have PostgreSQL functions ever really done for us?</p><p><img src="'+c+'" alt="Apart from security, performance, maintainability, and availability, what have stored procedures ever done for us?"></p><p>I really don&#39;t know.</p><hr><p>PostgreSQL functions are Clean Code for your database. Start using them.</p>',154)),r(i,{"get-started":[{text:"Quick Start Guide",href:"/guide/quick-start"},{text:"Benchmark Results",href:"/blog/postgresql-rest-api-benchmark-2026"},{text:"Security Guide",href:"/guide/security"},{text:"Function Annotations",href:"/annotations/"}]})])}const f=n(g,[["render",E]]);export{D as __pageData,f as default};
